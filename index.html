// Simplified approach for GHL Custom Pages
// This uses the existing session since you're already inside GHL

class GHLSimpleAPI {
    constructor() {
        this.locationId = this.getLocationId();
    }
    
    getLocationId() {
        // Try multiple methods to get location ID
        
        // Method 1: From URL
        const urlParams = new URLSearchParams(window.location.search);
        let locationId = urlParams.get('locationId') || urlParams.get('location_id');
        
        // Method 2: From URL path
        if (!locationId) {
            const pathMatch = window.location.pathname.match(/location\/([a-zA-Z0-9]+)/);
            if (pathMatch) {
                locationId = pathMatch[1];
            }
        }
        
        // Method 3: From parent frame
        if (!locationId && window.parent !== window) {
            try {
                const parentUrl = new URL(window.parent.location.href);
                locationId = parentUrl.searchParams.get('locationId');
            } catch (e) {
                console.log('Cannot access parent frame');
            }
        }
        
        console.log('Detected Location ID:', locationId);
        return locationId;
    }
    
    async fetchContacts(limit = 100, offset = 0) {
        if (!this.locationId) {
            throw new Error('Location ID not found. Please ensure you are accessing this from within GHL.');
        }
        
        try {
            // Try using relative API path (works if inside GHL)
            const response = await fetch(`/api/v1/contacts?locationId=${this.locationId}&limit=${limit}&offset=${offset}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('Fetched contacts:', data);
                return data.contacts || [];
            }
            
            // If relative path fails, try with your OAuth credentials
            console.log('Relative API failed, need OAuth authentication');
            return [];
            
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        }
    }
    
    async testConnection() {
        try {
            const contacts = await this.fetchContacts(5);
            if (contacts.length > 0) {
                console.log('✅ API connection successful!');
                console.log('Sample contact:', contacts[0]);
                return true;
            } else {
                console.log('⚠️ API connected but no contacts found');
                return false;
            }
        } catch (error) {
            console.error('❌ API connection failed:', error);
            return false;
        }
    }
}

// Initialize and use
const ghlAPI = new GHLSimpleAPI();

// Update your existing functions to use this
async function fetchGHLContacts(limit = 100, offset = 0) {
    try {
        return await ghlAPI.fetchContacts(limit, offset);
    } catch (error) {
        console.error('Fetch failed:', error);
        
        // Show auth instructions if needed
        showError(`
            Unable to fetch contacts. This may be because:
            1. The page needs to be accessed from within GHL
            2. OAuth authentication is required
            
            Location ID: ${ghlAPI.locationId || 'Not detected'}
        `);
        return [];
    }
}

// Test the connection on page load
window.addEventListener('DOMContentLoaded', async function() {
    console.log('Testing GHL API connection...');
    const connected = await ghlAPI.testConnection();
    
    if (connected) {
        showSuccess('Connected to GHL API successfully!');
        refreshFields();
    } else {
        showError('Please ensure you are accessing this page from within GHL');
    }
});
