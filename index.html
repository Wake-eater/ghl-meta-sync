// GHL API Integration
let currentLocationId = '';
let apiToken = '';
let contactsData = [];
const FIELD_MAPPING = {
    hashed_email: 'hashed_email',
    hashed_phone: 'hashed_phone',
    first_name: 'firstName',
    last_name: 'lastName',
    city: 'city',
    state: 'state',
    country: 'country',
    zip: 'postalCode'
};

// GHL API Integration
async function getGHLContext() {
    try {
        // Method 1: Get from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentLocationId = urlParams.get('locationId') || urlParams.get('location_id') || '';
        
        // Method 2: Get from parent frame (if in iframe)
        if (window.parent !== window) {
            try {
                const parentUrl = new URL(window.parent.location.href);
                const parentParams = new URLSearchParams(parentUrl.search);
                if (!currentLocationId) {
                    currentLocationId = parentParams.get('locationId') || parentParams.get('location_id') || '';
                }
            } catch (e) {
                console.log('Cannot access parent URL');
            }
        }
        
        // Method 3: Extract from current URL path
        if (!currentLocationId) {
            const pathMatch = window.location.pathname.match(/location\/([a-zA-Z0-9]+)/);
            if (pathMatch) {
                currentLocationId = pathMatch[1];
            }
        }
        
        console.log('Location ID:', currentLocationId);
        
        // Get access token from GHL session
        apiToken = await getAccessToken();
        
    } catch (error) {
        console.error('Context error:', error);
    }
}

async function getAccessToken() {
    // Try multiple methods to get the token
    
    // Method 1: From localStorage (GHL stores tokens here)
    try {
        const stored = localStorage.getItem('access_token');
        if (stored) return stored;
    } catch (e) {}
    
    // Method 2: From sessionStorage
    try {
        const session = sessionStorage.getItem('access_token');
        if (session) return session;
    } catch (e) {}
    
    // Method 3: From cookies - try multiple possible names
    const token = getCookie('token') || getCookie('auth_token') || getCookie('access_token');
    if (token) return token;
    
    // Method 4: Make a request to get current session
    try {
        const response = await fetch('/api/v1/users/me', {
            credentials: 'include'
        });
        if (response.ok) {
            const authHeader = response.headers.get('Authorization');
            if (authHeader) {
                return authHeader.replace('Bearer ', '');
            }
        }
    } catch (e) {}
    
    console.warn('No access token found - API calls may fail');
    return '';
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

// Fetch real contacts from GHL API
async function fetchGHLContacts(limit = 100, offset = 0) {
    try {
        // Build the API URL - FIXED: removed extra space and trailing slash
        const baseUrl = 'https://services.leadconnectorhq.com';
        const apiUrl = `${baseUrl}/contacts?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`;

        // Make the API call
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
            },
            credentials: 'include'
        });
        
        if (!response.ok) {
            console.error('API Error:', response.status, response.statusText);
            
            // Fallback: Try without auth header (relies on session cookies)
            const fallbackResponse = await fetch(`/api/v1/contacts?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`, {
                credentials: 'include'
            });
            
            if (fallbackResponse.ok) {
                const data = await fallbackResponse.json();
                return data.contacts || [];
            }
            
            throw new Error(`API call failed: ${response.status}`);
        }
        
        const data = await response.json();
        return data.contacts || [];
        
    } catch (error) {
        console.error('Failed to fetch contacts:', error);
        
        // If API fails, show error message with instructions
        showError('Unable to fetch contacts. Please ensure you have the proper permissions.');
        return [];
    }
}

// Fetch all contacts with pagination
async function fetchAllContacts() {
    let allContacts = [];
    let offset = 0;
    const limit = 100;
    let hasMore = true;
    
    showLoading(`Fetching contacts...`);
    
    while (hasMore) {
        try {
            const batch = await fetchGHLContacts(limit, offset);
            
            if (batch.length === 0) {
                hasMore = false;
            } else {
                allContacts = allContacts.concat(batch);
                offset += limit;
                
                // Update progress
                showLoading(`Fetched ${allContacts.length} contacts...`);
                if (document.getElementById('totalContacts')) {
                    document.getElementById('totalContacts').textContent = allContacts.length;
                }
                
                // Check if we have more
                hasMore = batch.length === limit;
            }
        } catch (error) {
            console.error('Error fetching batch:', error);
            hasMore = false;
        }
    }
    
    return allContacts;
}

// Check and display field preview
function displayFieldPreview(contacts) {
    const fieldsList = document.getElementById('fieldsList');
    if (!fieldsList) return;
    
    let html = '';
    let foundCount = 0;
    
    // Create a preview table
    html += '<h3 style="margin-bottom: 15px;">Field Mapping Preview:</h3>';
    html += '<table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr style="background: #f0f0f0;">';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Meta Field</th>';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">GHL Field</th>';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Sample Value</th>';
    html += '</tr></thead><tbody>';
    
    for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
        const fieldData = getFieldSample(contacts, ghlField);
        const hasField = fieldData.found;
        if (hasField) foundCount++;
        
        html += '<tr>';
        html += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${metaField.toUpperCase()}</strong></td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd;">${ghlField}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd;">`;
        html += `<span style="padding: 4px 8px; border-radius: 4px; background: ${hasField ? '#d4edda' : '#f8d7da'}; color: ${hasField ? '#155724' : '#721c24'};">${hasField ? '✓ Found' : '✗ Missing'}</span>`;
        html += `</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">`;
        if (fieldData.sample) {
            html += `${fieldData.sample.substring(0, 30)}${fieldData.sample.length > 30 ? '...' : ''}`;
        } else {
            html += '<em style="color: #999;">No data</em>';
        }
        html += `</td>`;
        html += '</tr>';
    }
    
    html += '</tbody></table>';
    
    // Add sample CSV preview
    if (contacts.length > 0 && foundCount > 0) {
        html += '<h3 style="margin-top: 20px; margin-bottom: 15px;">Sample CSV Output (First Row):</h3>';
        html += '<pre style="background: #f5f5f5; padding: 15px; border-radius: 5px; overflow-x: auto; font-size: 12px;">';
        
        const sampleRow = transformToMetaFormat(contacts.slice(0, 1))[0];
        if (sampleRow) {
            // Show headers
            html += Object.keys(FIELD_MAPPING).join(',') + '\n';
            // Show first row data
            html += Object.keys(FIELD_MAPPING).map(field => {
                const value = sampleRow[field] || '';
                return value ? `"${value.replace(/"/g, '""')}"` : '""';
            }).join(',');
        }
        
        html += '</pre>';
    }
    
    fieldsList.innerHTML = html;
    
    // Enable export if we have minimum fields
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.disabled = foundCount < 1;
    }
    
    if (document.getElementById('hashedFields')) {
        document.getElementById('hashedFields').textContent = foundCount;
    }
}

function getFieldSample(contacts, fieldName) {
    for (const contact of contacts) {
        // Check custom fields array
        if (contact.customFields && Array.isArray(contact.customFields)) {
            const field = contact.customFields.find(f => f.key === fieldName || f.id === fieldName);
            if (field && field.value) {
                return { found: true, sample: field.value };
            }
        }
        
        // Check custom field object
        if (contact.customField && typeof contact.customField === 'object') {
            if (contact.customField[fieldName]) {
                return { found: true, sample: contact.customField[fieldName] };
            }
        }
        
        // Check direct properties
        if (contact[fieldName]) {
            return { found: true, sample: contact[fieldName] };
        }
    }
    
    return { found: false, sample: null };
}

// Transform contacts to Meta format
function transformToMetaFormat(contacts) {
    return contacts
        .filter(contact => {
            // Must have at least email or phone
            const emailField = getContactField(contact, 'hashed_email');
            const phoneField = getContactField(contact, 'hashed_phone');
            return emailField || phoneField;
        })
        .map(contact => {
            const row = {};
            for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
                row[metaField] = getContactField(contact, ghlField) || '';
            }
            return row;
        });
}

function getContactField(contact, fieldName) {
    // Check custom fields array
    if (contact.customFields && Array.isArray(contact.customFields)) {
        const field = contact.customFields.find(f => f.key === fieldName || f.id === fieldName);
        if (field) return field.value;
    }
    
    // Check custom field object
    if (contact.customField && typeof contact.customField === 'object') {
        if (contact.customField[fieldName]) {
            return contact.customField[fieldName];
        }
    }
    
    // Check direct properties
    return contact[fieldName] || '';
}

// Update the refreshFields function
async function refreshFields() {
    showLoading('Fetching contact data...');
    
    try {
        // Get location context first
        await getGHLContext();
        
        if (!currentLocationId) {
            showError('Unable to determine location. Please try refreshing the page.');
            hideLoading();
            return;
        }
        
        // Fetch sample contacts
        const contacts = await fetchGHLContacts(20); // Get 20 samples for preview
        
        if (contacts.length === 0) {
            showError('No contacts found. Please check your permissions and try again.');
            hideLoading();
            return;
        }
        
        contactsData = contacts;
        
        // Display field mapping and preview
        displayFieldPreview(contacts);
        updateStatistics(contacts);
        
        hideLoading();
        showSuccess(`Found ${contacts.length} sample contacts. Ready to export!`);
        
    } catch (error) {
        hideLoading();
        showError('Failed to fetch contacts: ' + error.message);
        console.error('Refresh error:', error);
    }
}

// Export to CSV function
async function exportToMeta() {
    showLoading('Exporting contacts...');
    
    try {
        const contacts = await fetchAllContacts();
        const rows = transformToMetaFormat(contacts);

        if (rows.length === 0) {
            showError('No valid contacts found for export.');
            hideLoading();
            return;
        }

        const csv = [
            Object.keys(FIELD_MAPPING).join(','),
            ...rows.map(row => Object.values(row).map(val => `"${String(val).replace(/"/g, '""')}"`).join(','))
        ].join('\n');

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', 'meta-audience-sync.csv');
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        hideLoading();
        showSuccess(`Exported ${rows.length} contacts successfully!`);

    } catch (error) {
        hideLoading();
        showError('Export failed: ' + error.message);
        console.error('Export error:', error);
    }
}

// Utility functions for UI updates
function showLoading(message) {
    const loadingEl = document.getElementById('loadingMessage');
    if (loadingEl) {
        loadingEl.textContent = message;
        loadingEl.style.display = 'block';
    }
}

function hideLoading() {
    const loadingEl = document.getElementById('loadingMessage');
    if (loadingEl) {
        loadingEl.style.display = 'none';
    }
}

function showError(message) {
    const errorEl = document.getElementById('errorMessage');
    if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
    }
    setTimeout(() => {
        if (errorEl) errorEl.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    const successEl = document.getElementById('successMessage');
    if (successEl) {
        successEl.textContent = message;
        successEl.style.display = 'block';
    }
    setTimeout(() => {
        if (successEl) successEl.style.display = 'none';
    }, 3000);
}

function updateStatistics(contacts) {
    // Update any statistics display
    if (document.getElementById('totalContacts')) {
        document.getElementById('totalContacts').textContent = contacts.length;
    }
}
