// GHL API Integration
let currentLocationId = '';
let apiToken = '';
let contactsData = [];
let FIELD_MAPPING = {
    hashed_email: 'hashed_email',
    hashed_phone: 'hashed_phone',
    first_name: 'firstName',
    last_name: 'lastName',
    city: 'city',
    state: 'state',
    country: 'country',
    zip: 'postalCode'
};

// GHL API Integration
async function getGHLContext() {
    try {
        // Method 1: Get from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentLocationId = urlParams.get('locationId') || urlParams.get('location_id') || '';
        
        // Method 2: Get from parent frame (if in iframe)
        if (window.parent !== window) {
            try {
                const parentUrl = new URL(window.parent.location.href);
                const parentParams = new URLSearchParams(parentUrl.search);
                if (!currentLocationId) {
                    currentLocationId = parentParams.get('locationId') || parentParams.get('location_id') || '';
                }
            } catch (e) {
                console.log('Cannot access parent URL');
            }
        }
        
        // Method 3: Extract from current URL path
        if (!currentLocationId) {
            const pathMatch = window.location.pathname.match(/location\/([a-zA-Z0-9]+)/);
            if (pathMatch) {
                currentLocationId = pathMatch[1];
            }
        }
        
        console.log('Location ID:', currentLocationId);
        
        // Get access token from GHL session
        apiToken = await getAccessToken();
        
    } catch (error) {
        console.error('Context error:', error);
    }
}

async function getAccessToken() {
    // Try multiple methods to get the token
    
    // Method 1: From localStorage (GHL stores tokens here)
    try {
        const stored = localStorage.getItem('access_token');
        if (stored) return stored;
    } catch (e) {}
    
    // Method 2: From sessionStorage
    try {
        const session = sessionStorage.getItem('access_token');
        if (session) return session;
    } catch (e) {}
    
    // Method 3: From cookies - try multiple possible names
    const token = getCookie('token') || getCookie('auth_token') || getCookie('access_token');
    if (token) return token;
    
    // Method 4: Make a request to get current session
    try {
        const response = await fetch('/api/v1/users/me', {
            credentials: 'include'
        });
        if (response.ok) {
            const authHeader = response.headers.get('Authorization');
            if (authHeader) {
                return authHeader.replace('Bearer ', '');
            }
        }
    } catch (e) {}
    
    console.warn('No access token found - API calls may fail');
    return '';
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}

// Fetch real contacts from GHL API
async function fetchGHLContacts(limit = 100, offset = 0) {
    try {
        // Build the API URL - FIXED: removed extra space and trailing slash
        const baseUrl = 'https://services.leadconnectorhq.com';
        const apiUrl = `${baseUrl}/contacts?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`;

        // Make the API call
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
            },
            credentials: 'include'
        });
        
        if (!response.ok) {
            console.error('API Error:', response.status, response.statusText);
            
            // Fallback: Try without auth header (relies on session cookies)
            const fallbackResponse = await fetch(`/api/v1/contacts?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`, {
                credentials: 'include'
            });
            
            if (fallbackResponse.ok) {
                const data = await fallbackResponse.json();
                return data.contacts || [];
            }
            
            throw new Error(`API call failed: ${response.status}`);
        }
        
        const data = await response.json();
        return data.contacts || [];
        
    } catch (error) {
        console.error('Failed to fetch contacts:', error);
        
        // If API fails, show error message with instructions
        showError('Unable to fetch contacts. Please ensure you have the proper permissions.');
        return [];
    }
}

// Fetch all contacts with pagination
async function fetchAllContacts() {
    let allContacts = [];
    let offset = 0;
    const limit = 100;
    let hasMore = true;
    
    showLoading(`Fetching contacts...`);
    
    while (hasMore) {
        try {
            const batch = await fetchGHLContacts(limit, offset);
            
            if (batch.length === 0) {
                hasMore = false;
            } else {
                allContacts = allContacts.concat(batch);
                offset += limit;
                
                // Update progress
                showLoading(`Fetched ${allContacts.length} contacts...`);
                document.getElementById('totalContacts').textContent = allContacts.length;
                
                // Check if we have more
                hasMore = batch.length === limit;
            }
        } catch (error) {
            console.error('Error fetching batch:', error);
            hasMore = false;
        }
    }
    
    return allContacts;
}

// Check and display field preview
function displayFieldPreview(contacts) {
    const fieldsList = document.getElementById('fieldsList');
    let html = '';
    let foundCount = 0;
    
    // Create a preview table
    html += '<h3 style="margin-bottom: 15px;">Field Mapping Preview:</h3>';
    html += '<table style="width: 100%; border-collapse: collapse;">';
    html += '<thead><tr style="background: #f0f0f0;">';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Meta Field</th>';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">GHL Field</th>';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Status</th>';
    html += '<th style="padding: 10px; text-align: left; border: 1px solid #ddd;">Sample Value</th>';
    html += '</tr></thead><tbody>';
    
    for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
        const fieldData = getFieldSample(contacts, ghlField);
        const hasField = fieldData.found;
        if (hasField) foundCount++;
        
        html += '<tr>';
        html += `<td style="padding: 10px; border: 1px solid #ddd;"><strong>${metaField.toUpperCase()}</strong></td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd;">${ghlField}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd;">`;
        html += `<span class="badge ${hasField ? 'badge-success' : 'badge-error'}">${hasField ? '✓ Found' : '✗ Missing'}</span>`;
        html += `</td>`;
        html += `<td style="padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 12px;">`;
        if (fieldData.sample) {
            // Show first 20 chars of the
