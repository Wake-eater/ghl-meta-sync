// GHL Custom App Integration
let currentLocationId = '';
let apiToken = '';
let contactsData = [];
const FIELD_MAPPING = {
    hashed_email: 'hashed_email',
    hashed_phone: 'hashed_phone',
    first_name: 'firstName',
    last_name: 'lastName',
    city: 'city',
    state: 'state',
    country: 'country',
    zip: 'postalCode'
};

// **CHANGED**: Use GHL's recommended initialization method
if (window.GHL) {
    window.GHL.on('ready', initializeApp);
} else {
    // Fallback for when GHL object is not immediately available
    document.addEventListener('DOMContentLoaded', () => {
        // Retry GHL connection after a short delay
        setTimeout(() => {
            if (window.GHL) {
                window.GHL.on('ready', initializeApp);
            } else {
                console.error('GHL object not found. App cannot initialize.');
                showGHLMessage('error', 'Could not connect to GoHighLevel. Please refresh.');
            }
        }, 500);
    });
}

async function initializeApp() {
    console.log('GHL is ready. Initializing app...');
    // Add event listeners
    document.getElementById('refreshBtn').addEventListener('click', refreshFields);
    document.getElementById('exportBtn').addEventListener('click', exportToMeta);

    // **CHANGED**: Get context using modern GHL methods
    try {
        currentLocationId = await window.GHL.getLocation();
        apiToken = await window.GHL.getToken();

        if (!currentLocationId) {
            throw new Error('Could not get Location ID from GHL.');
        }
        if (!apiToken) {
            throw new Error('Could not get API Token from GHL.');
        }

        console.log('GHL Location ID:', currentLocationId);
        // Auto-refresh on load
        await refreshFields();

    } catch (error) {
        console.error('Initialization failed:', error);
        showGHLMessage('error', `Initialization Error: ${error.message}`);
    }
}


// **REMOVED**: The old getGHLContext, getAccessToken, and getCookie functions are no longer needed.


// GHL API Call - Simplified and more robust
async function fetchGHLContacts(limit = 50, offset = 0) {
    // **CHANGED**: Simplified the function to use the reliable token and location ID
    if (!currentLocationId || !apiToken) {
        showGHLMessage('error', 'Missing GHL Location ID or Token.');
        return [];
    }

    try {
        const baseUrl = 'https://services.leadconnectorhq.com';
        const apiUrl = `${baseUrl}/contacts/?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`;

        console.log('Fetching GHL contacts:', apiUrl);

        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
            }
        });

        if (!response.ok) {
            // Provide more specific error feedback
            const errorBody = await response.text();
            console.error('GHL API Error:', response.status, response.statusText, errorBody);
            throw new Error(`GHL API responded with status ${response.status}. Check console for details.`);
        }

        const data = await response.json();
        console.log('GHL Contacts fetched:', data.contacts ? data.contacts.length : 0);
        return data.contacts || [];

    } catch (error) {
        console.error('GHL Contacts fetch error:', error);
        showGHLMessage('error', `Unable to fetch contacts: ${error.message}`);
        return [];
    }
}

// Main refresh function
async function refreshFields() {
    showGHLMessage('loading', 'Fetching contact data from GHL...');
    // **CHANGED**: Removed the call to getGHLContext as it's now handled in initializeApp
    try {
        // Fetch a small sample for the preview
        const contacts = await fetchGHLContacts(20);

        if (!contacts || contacts.length === 0) {
            showGHLMessage('warning', 'No contacts found in this location.');
            const fieldsList = document.getElementById('fieldsList');
            if (fieldsList) fieldsList.innerHTML = '';
            updateFieldCounters(0, 0);
            return;
        }

        contactsData = contacts;
        displayFieldPreview(contacts);
        showGHLMessage('success', `Found ${contacts.length} sample contacts. Ready to export!`);

    } catch (error) {
        console.error('Refresh error:', error);
        showGHLMessage('error', 'Failed to fetch contacts: ' + error.message);
    }
}


// Export function
async function exportToMeta() {
    showGHLMessage('loading', 'Exporting all contacts...');

    try {
        // Fetch all contacts with pagination
        let allContacts = [];
        let offset = 0;
        const limit = 100;
        let hasMore = true;

        while (hasMore) {
            showGHLMessage('loading', `Fetching contacts... currently at ${allContacts.length}`);
            const batch = await fetchGHLContacts(limit, offset);
            if (batch.length > 0) {
                allContacts.push(...batch);
                offset += limit;
            } else {
                hasMore = false;
            }
        }

        const rows = transformToMetaFormat(allContacts);

        if (rows.length === 0) {
            showGHLMessage('warning', 'No contacts with hashed email or phone were found for export.');
            return;
        }

        // Generate CSV
        const csv = [
            Object.keys(FIELD_MAPPING).join(','),
            ...rows.map(row =>
                Object.keys(FIELD_MAPPING).map(field => {
                    const val = row[field] || '';
                    return `"${String(val).replace(/"/g, '""')}"`;
                }).join(',')
            )
        ].join('\n');

        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `meta-audience-${currentLocationId}-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showGHLMessage('success', `Exported ${rows.length} contacts successfully!`);

    } catch (error) {
        console.error('Export error:', error);
        showGHLMessage('error', 'Export failed: ' + error.message);
    }
}


// =======================================================================
// HELPER FUNCTIONS (No changes needed below this line)
// =======================================================================

// GHL Field Preview
function displayFieldPreview(contacts) {
    const fieldsList = document.getElementById('fieldsList');
    if (!fieldsList) {
        console.error('Fields list container not found');
        return;
    }

    let html = '';
    let foundCount = 0;

    // Create GHL-styled table
    html += '<div class="ghl-field-preview">';
    html += '<h4 style="margin-bottom: 15px; color: #333;">Field Mapping Preview</h4>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-bordered" style="width: 100%; border-collapse: collapse; background: white;">';
    html += '<thead style="background-color: #f8f9fa;">';
    html += '<tr>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Meta Field</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">GHL Field</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Status</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Sample Value</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';

    for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
        const fieldData = getFieldSample(contacts, ghlField);
        const hasField = fieldData.found;
        if (hasField) foundCount++;

        html += '<tr style="border-bottom: 1px solid #dee2e6;">';
        html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${metaField.replace(/_/g, ' ').toUpperCase()}</strong></td>`;
        html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${ghlField}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #dee2e6;">`;
        html += `<span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; ${
            hasField ? 'background-color: #d4edda; color: #155724;' : 'background-color: #f8d7da; color: #721c24;'
        }">${hasField ? '✓ Found' : '✗ Missing'}</span>`;
        html += `</td>`;
        html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-family: monospace; font-size: 11px;">`;
        if (fieldData.sample) {
            html += `${String(fieldData.sample).substring(0, 25)}${String(fieldData.sample).length > 25 ? '...' : ''}`;
        } else {
            html += '<em style="color: #6c757d;">No data</em>';
        }
        html += `</td>`;
        html += '</tr>';
    }

    html += '</tbody>';
    html += '</table>';
    html += '</div>';

    // CSV Preview
    if (contacts.length > 0 && foundCount > 0) {
        html += '<div style="margin-top: 20px;">';
        html += '<h4 style="margin-bottom: 10px; color: #333;">Sample CSV Output</h4>';
        html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto;">';

        const sampleRow = transformToMetaFormat(contacts.slice(0, 1))[0];
        if (sampleRow) {
            html += '<div>' + Object.keys(FIELD_MAPPING).join(', ') + '</div>';
            html += '<div>' + Object.keys(FIELD_MAPPING).map(field => {
                const value = sampleRow[field] || '';
                return value ? `"${String(value).replace(/"/g, '""')}"` : '""';
            }).join(', ') + '</div>';
        }

        html += '</div>';
        html += '</div>';
    }

    html += '</div>';
    fieldsList.innerHTML = html;
    updateFieldCounters(foundCount, contacts.length);
}

function updateFieldCounters(foundCount, totalContacts) {
    const hashedFieldsEl = document.getElementById('hashedFields');
    const totalContactsEl = document.getElementById('totalContacts');

    if (hashedFieldsEl) hashedFieldsEl.textContent = foundCount;
    if (totalContactsEl) totalContactsEl.textContent = totalContacts;

    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.disabled = foundCount < 1;
        exportBtn.title = foundCount < 1 ? 'No mappable fields found' : 'Export contacts to Meta';
    }
}

function getFieldSample(contacts, fieldName) {
    for (const contact of contacts) {
        const value = getContactField(contact, fieldName);
        if (value) {
            return { found: true, sample: value };
        }
    }
    return { found: false, sample: null };
}

function transformToMetaFormat(contacts) {
    return contacts
        .map(contact => {
            const row = {};
            let hasIdentifier = false;
            for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
                const value = getContactField(contact, ghlField) || '';
                row[metaField] = value;
                if ((ghlField === 'hashed_email' || ghlField === 'hashed_phone') && value) {
                    hasIdentifier = true;
                }
            }
            return hasIdentifier ? row : null;
        })
        .filter(row => row !== null);
}

function getContactField(contact, fieldName) {
    // Check direct properties first (most common for standard fields)
    if (contact[fieldName] !== undefined && contact[fieldName] !== null && contact[fieldName] !== '') {
        return contact[fieldName];
    }
    // Check custom fields array (GHL standard for custom data)
    if (contact.customFields && Array.isArray(contact.customFields)) {
        const field = contact.customFields.find(f => f.key === fieldName);
        if (field && field.value) return field.value;
    }
    return '';
}

function showGHLMessage(type, message) {
    const messageContainer = document.getElementById('messageContainer');
    if (!messageContainer) return;

    const alertClass = {
        'success': 'alert-success', 'error': 'alert-danger',
        'warning': 'alert-warning', 'loading': 'alert-info'
    }[type] || 'alert-info';
    const icon = {
        'success': '✓', 'error': '✗', 'warning': '⚠', 'loading': '↻'
    }[type] || 'ℹ';

    messageContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="margin-bottom: 15px;">
            <strong>${icon}</strong> ${message}
        </div>`;

    if (type === 'success' || type === 'warning') {
        setTimeout(() => {
            const alert = messageContainer.querySelector('.alert');
            if (alert) alert.remove();
        }, 4000);
    }
}
