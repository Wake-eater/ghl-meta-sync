// GHL Custom App Integration
let currentLocationId = '';
let apiToken = '';
let contactsData = [];
const FIELD_MAPPING = {
    hashed_email: 'hashed_email',
    hashed_phone: 'hashed_phone',
    first_name: 'firstName',
    last_name: 'lastName',
    city: 'city',
    state: 'state',
    country: 'country',
    zip: 'postalCode'
};

// Initialize when GHL is ready
if (window.GHL && window.GHL.onLoad) {
    window.GHL.onLoad(function() {
        initializeApp();
    });
} else {
    document.addEventListener('DOMContentLoaded', function() {
        initializeApp();
    });
}

function initializeApp() {
    // Add event listeners
    const refreshBtn = document.getElementById('refreshBtn');
    const exportBtn = document.getElementById('exportBtn');
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', refreshFields);
    }
    
    if (exportBtn) {
        exportBtn.addEventListener('click', exportToMeta);
    }
    
    // Auto-refresh on load
    refreshFields();
}

// GHL Context - Works with GHL's iframe environment
async function getGHLContext() {
    try {
        // Method 1: Get from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        currentLocationId = urlParams.get('locationId') || urlParams.get('location_id') || '';
        
        // Method 2: Get from parent frame (GHL iframe context)
        if ((!currentLocationId || currentLocationId === 'null') && window.parent !== window) {
            try {
                const parentData = window.parent.location.search;
                const parentParams = new URLSearchParams(parentData);
                currentLocationId = parentParams.get('locationId') || parentParams.get('location_id') || '';
            } catch (e) {
                console.log('Cannot access parent frame params');
            }
        }
        
        // Method 3: Extract from GHL path structure
        if (!currentLocationId) {
            const pathMatches = window.location.pathname.match(/locations\/([a-zA-Z0-9-]+)/);
            if (pathMatches && pathMatches[1]) {
                currentLocationId = pathMatches[1];
            }
        }
        
        console.log('GHL Location ID:', currentLocationId);
        
        // Get access token from GHL session
        apiToken = await getAccessToken();
        
        return !!currentLocationId;
    } catch (error) {
        console.error('GHL Context error:', error);
        return false;
    }
}

// GHL Token Retrieval - Optimized for GHL's auth system
async function getAccessToken() {
    try {
        // GHL typically stores token in localStorage with specific key
        const token = localStorage.getItem('token') || 
                     localStorage.getItem('access_token') || 
                     localStorage.getItem('ghl_token');
        
        if (token) {
            console.log('Token found in localStorage');
            return token;
        }
        
        // Check cookies (GHL often uses 'token' cookie)
        const cookieToken = getCookie('token') || getCookie('access_token');
        if (cookieToken) {
            console.log('Token found in cookies');
            return cookieToken;
        }
        
        // Fallback: Try GHL's internal auth endpoint
        const response = await fetch('/api/v1/users/me', {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data && data.token) {
                return data.token;
            }
        }
        
    } catch (e) {
        console.log('Token retrieval fallback:', e.message);
    }
    
    console.warn('No GHL access token found - relying on session cookies');
    return '';
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
}

// GHL API Call - Optimized for GHL's API structure
async function fetchGHLContacts(limit = 50, offset = 0) {
    try {
        // Use GHL's services endpoint
        const baseUrl = 'https://services.leadconnectorhq.com';
        const apiUrl = `${baseUrl}/contacts?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`;

        console.log('Fetching GHL contacts:', apiUrl);
        
        const response = await fetch(apiUrl, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${apiToken}`,
                'Content-Type': 'application/json',
                'Version': '2021-07-28'
            },
            credentials: 'include'
        });
        
        if (!response.ok) {
            console.error('GHL API Error:', response.status, response.statusText);
            
            // GHL Fallback: Try relative path (uses session)
            const fallbackResponse = await fetch(`/api/v1/contacts?locationId=${currentLocationId}&limit=${limit}&offset=${offset}`, {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'Accept': 'application/json'
                }
            });
            
            if (fallbackResponse.ok) {
                const data = await fallbackResponse.json();
                return data.contacts || [];
            }
            
            throw new Error(`GHL API failed: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        console.log('GHL Contacts fetched:', data.contacts ? data.contacts.length : 0);
        return data.contacts || [];
        
    } catch (error) {
        console.error('GHL Contacts fetch error:', error);
        showGHLMessage('error', 'Unable to fetch contacts. Check permissions.');
        return [];
    }
}

// GHL Field Preview - Properly formatted for GHL's UI
function displayFieldPreview(contacts) {
    const fieldsList = document.getElementById('fieldsList');
    if (!fieldsList) {
        console.error('Fields list container not found');
        return;
    }
    
    let html = '';
    let foundCount = 0;
    
    // Create GHL-styled table
    html += '<div class="ghl-field-preview">';
    html += '<h4 style="margin-bottom: 15px; color: #333;">Field Mapping Preview</h4>';
    html += '<div class="table-responsive">';
    html += '<table class="table table-bordered" style="width: 100%; border-collapse: collapse; background: white;">';
    html += '<thead style="background-color: #f8f9fa;">';
    html += '<tr>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Meta Field</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">GHL Field</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Status</th>';
    html += '<th style="padding: 12px; text-align: left; border: 1px solid #dee2e6; font-weight: 600;">Sample Value</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
        const fieldData = getFieldSample(contacts, ghlField);
        const hasField = fieldData.found;
        if (hasField) foundCount++;
        
        html += '<tr style="border-bottom: 1px solid #dee2e6;">';
        html += `<td style="padding: 10px; border: 1px solid #dee2e6;"><strong>${metaField.replace('_', ' ').toUpperCase()}</strong></td>`;
        html += `<td style="padding: 10px; border: 1px solid #dee2e6;">${ghlField}</td>`;
        html += `<td style="padding: 10px; border: 1px solid #dee2e6;">`;
        html += `<span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; ${
            hasField ? 'background-color: #d4edda; color: #155724;' : 'background-color: #f8d7da; color: #721c24;'
        }">${hasField ? '✓ Found' : '✗ Missing'}</span>`;
        html += `</td>`;
        html += `<td style="padding: 10px; border: 1px solid #dee2e6; font-family: monospace; font-size: 11px;">`;
        if (fieldData.sample) {
            html += `${String(fieldData.sample).substring(0, 25)}${String(fieldData.sample).length > 25 ? '...' : ''}`;
        } else {
            html += '<em style="color: #6c757d;">No data</em>';
        }
        html += `</td>`;
        html += '</tr>';
    }
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    // CSV Preview
    if (contacts.length > 0 && foundCount > 0) {
        html += '<div style="margin-top: 20px;">';
        html += '<h4 style="margin-bottom: 10px; color: #333;">Sample CSV Output</h4>';
        html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; overflow-x: auto;">';
        
        const sampleRow = transformToMetaFormat(contacts.slice(0, 1))[0];
        if (sampleRow) {
            html += '<div>' + Object.keys(FIELD_MAPPING).join(', ') + '</div>';
            html += '<div>' + Object.keys(FIELD_MAPPING).map(field => {
                const value = sampleRow[field] || '';
                return value ? `"${String(value).replace(/"/g, '""')}"` : '""';
            }).join(', ') + '</div>';
        }
        
        html += '</div>';
        html += '</div>';
    }
    
    html += '</div>';
    
    // Render the HTML
    fieldsList.innerHTML = html;
    
    // Update counters
    updateFieldCounters(foundCount, contacts.length);
}

function updateFieldCounters(foundCount, totalContacts) {
    const hashedFieldsEl = document.getElementById('hashedFields');
    const totalContactsEl = document.getElementById('totalContacts');
    
    if (hashedFieldsEl) {
        hashedFieldsEl.textContent = foundCount;
    }
    if (totalContactsEl) {
        totalContactsEl.textContent = totalContacts;
    }
    
    // Enable/disable export button
    const exportBtn = document.getElementById('exportBtn');
    if (exportBtn) {
        exportBtn.disabled = foundCount < 1;
        if (foundCount < 1) {
            exportBtn.title = 'No valid fields found';
        } else {
            exportBtn.title = 'Export contacts to Meta';
        }
    }
}

function getFieldSample(contacts, fieldName) {
    for (const contact of contacts) {
        // Check custom fields array (most common in GHL)
        if (contact.customFields && Array.isArray(contact.customFields)) {
            const field = contact.customFields.find(f => f.key === fieldName);
            if (field && field.value) {
                return { found: true, sample: field.value };
            }
        }
        
        // Check custom field object
        if (contact.customField && typeof contact.customField === 'object') {
            if (contact.customField[fieldName]) {
                return { found: true, sample: contact.customField[fieldName] };
            }
        }
        
        // Check direct properties
        if (contact[fieldName] !== undefined && contact[fieldName] !== null) {
            return { found: true, sample: contact[fieldName] };
        }
    }
    
    return { found: false, sample: null };
}

function transformToMetaFormat(contacts) {
    return contacts
        .filter(contact => {
            const emailField = getContactField(contact, 'hashed_email');
            const phoneField = getContactField(contact, 'hashed_phone');
            return emailField || phoneField;
        })
        .map(contact => {
            const row = {};
            for (const [metaField, ghlField] of Object.entries(FIELD_MAPPING)) {
                row[metaField] = getContactField(contact, ghlField) || '';
            }
            return row;
        });
}

function getContactField(contact, fieldName) {
    // Check custom fields array (GHL standard)
    if (contact.customFields && Array.isArray(contact.customFields)) {
        const field = contact.customFields.find(f => f.key === fieldName);
        if (field && field.value) return field.value;
    }
    
    // Check custom field object
    if (contact.customField && typeof contact.customField === 'object') {
        if (contact.customField[fieldName]) {
            return contact.customField[fieldName];
        }
    }
    
    // Check direct properties
    if (contact[fieldName] !== undefined && contact[fieldName] !== null) {
        return contact[fieldName];
    }
    
    return '';
}

// Main refresh function
async function refreshFields() {
    showGHLMessage('loading', 'Fetching contact data from GHL...');
    
    try {
        const hasContext = await getGHLContext();
        
        if (!hasContext || !currentLocationId) {
            showGHLMessage('error', 'Unable to determine location context. Please refresh the page.');
            return;
        }
        
        const contacts = await fetchGHLContacts(20);
        
        if (!contacts || contacts.length === 0) {
            showGHLMessage('warning', 'No contacts found. Check your location permissions.');
            const fieldsList = document.getElementById('fieldsList');
            if (fieldsList) fieldsList.innerHTML = '';
            updateFieldCounters(0, 0);
            return;
        }
        
        contactsData = contacts;
        displayFieldPreview(contacts);
        showGHLMessage('success', `Found ${contacts.length} sample contacts. Ready to export!`);
        
    } catch (error) {
        console.error('Refresh error:', error);
        showGHLMessage('error', 'Failed to fetch contacts: ' + error.message);
    }
}

// GHL-Styled Message System
function showGHLMessage(type, message) {
    const messageContainer = document.getElementById('messageContainer');
    if (!messageContainer) return;
    
    const alertClass = {
        'success': 'alert-success',
        'error': 'alert-danger',
        'warning': 'alert-warning',
        'loading': 'alert-info'
    }[type] || 'alert-info';
    
    const icon = {
        'success': '✓',
        'error': '✗',
        'warning': '⚠',
        'loading': '↻'
    }[type] || 'ℹ';
    
    messageContainer.innerHTML = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert" style="margin-bottom: 15px;">
            <strong>${icon}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    
    // Auto-hide success/warning messages
    if (type === 'success' || type === 'warning') {
        setTimeout(() => {
            const alert = messageContainer.querySelector('.alert');
            if (alert) {
                alert.style.opacity = '0';
                setTimeout(() => {
                    if (alert.parentNode === messageContainer) {
                        messageContainer.removeChild(alert);
                    }
                }, 300);
            }
        }, type === 'success' ? 3000 : 5000);
    }
}

// Export function
async function exportToMeta() {
    showGHLMessage('loading', 'Exporting all contacts...');
    
    try {
        // Fetch all contacts
        let allContacts = [];
        let offset = 0;
        const limit = 100;
        let hasMore = true;
        
        while (hasMore) {
            const batch = await fetchGHLContacts(limit, offset);
            if (batch.length === 0) {
                hasMore = false;
            } else {
                allContacts = allContacts.concat(batch);
                offset += limit;
                showGHLMessage('loading', `Exporting... ${allContacts.length} contacts fetched`);
            }
        }
        
        const rows = transformToMetaFormat(allContacts);
        
        if (rows.length === 0) {
            showGHLMessage('warning', 'No valid contacts found for export.');
            return;
        }
        
        // Generate CSV
        const csv = [
            Object.keys(FIELD_MAPPING).join(','),
            ...rows.map(row => 
                Object.values(row).map(val => 
                    `"${String(val || '').replace(/"/g, '""')}"`
                ).join(',')
            )
        ].join('\n');
        
        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.setAttribute('href', url);
        a.setAttribute('download', `meta-audience-${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showGHLMessage('success', `Exported ${rows.length} contacts successfully!`);
        
    } catch (error) {
        console.error('Export error:', error);
        showGHLMessage('error', 'Export failed: ' + error.message);
    }
}
